<!DOCTYPE HTML>
<html>
<head>
    <title> 申请登记</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!--user-scalable控制用户是否可以进行触屏扩大或缩小网页-->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="/css/layui/layui.css">
    <link href="/css/suggest-style.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">

    <style type="text/css">
        code {
            padding: 0px 4px;
            color: #d14;
            background-color: #f7f7f9;
            border: 1px solid #e1e1e8;
        }

    </style>
</head>
<body>

<div class="container">

    <div>
        <div class="row">
            <div id="occupy_area" class="hidden col-xs-12 col-sm-12 col-md-1 col-lg-1"></div>
            <div id="reg_area" class="col-xs-12 col-sm-12 col-md-7 col-lg-7 col-md-offset-2 col-lg-offset-2">
                <!--偏移列 .col-*-offset-* -->
                <form class="form-horizontal layui-form" autocomplete="off" id="reg_area_form"
                      lay-filter="bar_code_register">
                    <h3 class="form-signin-heading" style="margin-top:20px;margin-bottom:5px; ">
                        <i id="reg_form_title" class="layui-icon layui-icon-list" style="font-size: 26px;">登记条码</i></h3>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px;padding-left:0px; ">
                        <label class="col-sm-12 col-xs-12 col-lg-12" style="margin-bottom:5px; ">条码号</label>
                        <div class="col-sm-1 col-xs-10 col-lg-1" style="padding-right:2px; width: 80%">
                            <input type="text" id="bar_code" class="form-control" name="bar_code"
                                   placeholder="请输入或扫码" lay-verify="required">
                        </div>
                        <div class="col-sm-1 col-xs-2 col-lg-1" style="margin-bottom:5px;padding-left:0px ">
                            <button type="button" id="reg_btn" class="btn btn-default " lay-on="get_bar_code">识码
                            </button>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px;padding-left:0px; ">
                        <label class="control-label" style="margin-bottom:5px;margin-left:15px; ">条码类别</label>
                        <div class="layui-input-block" style="margin-left:15px; width: 95%">
                            <select name="bar_code_genre" lay-filter="BC_genre" lay-verify="required">
                                <option value="1">设备码</option>
                                <option value="2" selected>配件\耗材码</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px;padding-left:0px; ">
                        <label class="control-label" style="margin-bottom:5px;margin-left:15px; ">种类选择</label>
                        <div class="layui-input-block" style="margin-left:15px; width: 95%">
                            <select name="bar_code_type" lay-filter="BC_type" lay-verify="required">
                                <option value=""></option>
                                <option value="1">附带码</option>
                                <option value="2">外包装码</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                            <label class="control-label" style="margin-bottom:5px; ">设备选择</label>
                            <div id="devices_class_div">
                                <input type="text" id="devices_class" class="form-control"
                                       name="devices_class"
                                       placeholder="请选择"
                                       lay-verType="alert"
                                       lay-reqText="请选择设备"
                                       lay-verify="required">
                                <ul class="dropdown-menu " role="menu">
                                </ul>
                            </div>
                        </div>

                        <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                            <label class="control-label" style="margin-bottom:5px; ">型号选择</label>
                            <div id="devices_entity_div">
                                <input type="text" id="devices_entity" class="form-control NO_Reset"
                                       name="devices_entity"
                                       placeholder="请选择">
                                <input type="hidden" name="entity_id" id="entity_id" lay-verify="required"
                                       lay-verType="alert"
                                       lay-reqText="请选择型号">
                                <ul class="dropdown-menu " role="menu">
                                </ul>
                            </div>
                        </div>

                        <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                            <label class="control-label" style="margin-bottom:5px; ">登记时间</label>
                            <div class="">
                                <input type="text" name="bar_code_date" id="bar_code_date"
                                       lay-verify="required|datetime"
                                       placeholder="yyyy-MM-dd HH:mm:ss"
                                       autocomplete="off" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="col-sm-12 col-xs-12 col-lg-12" style="margin-top: 10px">
                        <div>
                            <button type="button" class="btn btn-primary btn-block" id="bar_code_submit" lay-submit
                                    lay-filter="BC_submit">新增
                            </button>
                        </div>
                    </div>
                </form>
            </div>

        </div>
    </div>


</div>
<script type="text/javascript" src="/js/jquery-1.8.1.min.js"></script>

<script src="/js/layui/layui.js"></script>

<script type="text/javascript" src="/js/tree/tree_build.js"></script>
<script type="text/javascript" src="/js/localstorageIO.js"></script>
<script type="text/javascript" src="/js/tools/data_handling.js"></script>
<script type="text/javascript" src="/js/suggest/bootstrap-suggest.js"></script>

<script type="text/javascript" src="/js/suggest/suggest_util.js"></script>
<script type="text/javascript" src="/js/callback_ajax.js"></script>

<script type="text/javascript" src="http://res2.wx.qq.com/open/js/jweixin-1.6.0.js"></script>

<script type="text/javascript">

    var device_data = {},//全部dev初始化
        entity_data = [];//型号初始化

    function verify_bar_code(ident) {


        CD_ajaxAllParam("/getBar_codeByBar_code_ident", {
            bar_code_ident: ident,
            "TD": "logout"
        }, true, function (data) {
            if (data == null) {
                originalSeaEntity();
                return;
            }
            initEntityBsSuggest(0, "devices_class");
            initEntityBsSuggest(0, "devices_entity");
            var text = device_data.Entity_data.filter(function (entity, index) {
                if (data.bar_code.entity_id === entity.value) {
                    $('#devices_entity').val(entity.text);
                    $('#devices_entity').attr('readonly', true);
                    device_data.Class_data.filter(function (cla, index) {
                        if (entity.dev_class_id === cla.value) {
                            $('#devices_class').val(cla.text);
                            $('#devices_class').attr('readonly', true);
                        }
                    })
                }
            });

        });
    }

    //下拉框ajax请求entity_selectAjax
    function entity_selectAjax(url, callback) {

        $.ajax({
            url: url,
            data: {tab: 1},
            type: 'POST', //GET
            async: true,    //或false,是否异步
            /*timeout: 5000,*/    //超时时间(如果后台数据加载缓慢，设置超时时间会导致在时间超时后自动执行success函数而后台还没有返回data数据)
            dataType: 'json',    //返回的数据格式：json/xml/html/script/jsonp/text
            success: function (data, textStatus, jqXHR) {
                if (data != null && data != undefined) {
                    device_data = data;
                }
                //回调函数
                if (typeof callback === "function") {
                    //调用它，既然我们已经确定了它是可调用的
                    callback();
                }
            },
            error: function (xhr, textStatus) {
                console.log('错误')
                console.log(xhr)
                console.log(textStatus)
            }
        })
    }

    //型号生成
    function changeEntClass(ev, i) {
        entity_data = [];
        var Entity_data = device_data.Entity_data;
        for (var j = 0, len = Entity_data.length; j < len; j++) {
            if (Entity_data[j].dev_class_id == i) {
                entity_data.push(Entity_data[j]);
            }
        }
    }

    //下拉提示框bsSuggest
    function initEntityBsSuggest(t, cla, v, callback, onUnset_ck) {
        var options = {
            /*url: "/getMaterialName?tab=" + v,*/
            data: v,
            effectiveFields: ["text", "class_ident"],
            searchFields: ["text", "class_ident"],
            effectiveFieldsAlias: {class_ident: "编号", text: "名称"},
            listAlign: 'auto',
            showBtn: false,
            autoMinWidth: false,
            getDataMethod: 'data',
            idField: "value",
            keyField: "text",
            clearable: true,
        };
        if (t == 1) {
            $("#" + cla).bsSuggest('init', options).on('onDataRequestSuccess', function (e, result) {
                console.log('onDataRequestSuccess: ', result);
            }).on('onSetSelectValue', function (e, keyword, data) {
                console.log('onSetSelectValue: ', keyword, data);
                //回调函数
                if (typeof callback === "function") {
                    //调用它，既然我们已经确定了它是可调用的
                    callback(keyword, data);
                }

            }).on('onUnsetSelectValue', function () {
                if (typeof onUnset_ck === "function") {
                    //调用它，既然我们已经确定了它是可调用的
                    onUnset_ck();
                }
            });
        } else if (t == 0) {
            $("#" + cla).bsSuggest('destroy');
        }

    };

    //初始化BsSuggest
    function originalSeaEntity(v) {
        initEntityBsSuggest(0, "devices_class");
        initEntityBsSuggest(0, "devices_entity");
        $("#entity_id").val('');
        $('#devices_class_div').replaceWith('<div id="devices_class_div"><input type="text" id="devices_class" class="form-control" ' +
            'name="devices_class" placeholder="请选择" lay-verType="alert" lay-reqText="请选择设备" lay-verify="required"> ' +
            '<ul class="dropdown-menu " role="menu"> </ul> </div>');
        if (!$.isEmptyObject(device_data)) {
            initEntityBsSuggest(1, "devices_class", {value: device_data.Class_data}, function (K, data) {
                initEntityBsSuggest(0, "devices_entity");
                $('#devices_entity_div').replaceWith('<div id="devices_entity_div"> <input type="text" id="devices_entity" class="form-control NO_Reset" ' +
                    'name="devices_entity" placeholder="请选择"> <input type="hidden" name="entity_id" id="entity_id" lay-verify="required" lay-verType="alert" ' +
                    'lay-reqText="请选择型号"> <ul class="dropdown-menu " role="menu"> </ul> </div>');
                if (!$.isEmptyObject(data)) {
                    changeEntClass(K, data.value);
                    initEntityBsSuggest(1, "devices_entity", {value: entity_data}, function (K, data) {
                        $("#entity_id").val(data.value);
                    }, function () {
                        $("#entity_id").val('');
                    });
                }
            }, function () {
                $("#entity_id").val('');
            });
        }
    };

    function BC_submit(data) {

        data.field.TD = "logout";
        CD_ajaxAllParam("/sys_bar_code/addBar_code", data.field, true, function (v) {
                if (result_handle(v)) {
                    layer.msg('出库记录完成', {icon: 1, time: 1000,},
                        function (index) {
                            layer.close(index);
                        });
                } else {
                    layer.msg(v.error, {icon: 2, time: 5000,},
                        function (index) {
                            layer.close(index);
                        });
                }
            }
        );
    }

    $(function () {

        CD_ajaxAllParam("/makeSDKSignature", {
            url: "http://xxk-manage.nat300.top/test/testBar_code_reg",
            "TD": "logout"
        }, true, function (data) {
            wx.config({
                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                appId: data.appId, // 必填，公众号的唯一标识
                timestamp: data.timestamp, // 必填，生成签名的时间戳
                nonceStr: data.nonceStr, // 必填，生成签名的随机串
                signature: data.signature,// 必填，签名
                jsApiList: ['scanQRCode'] // 必填，需要使用的JS接口列表
            });
            wx.ready(function () {
                console.log('wx_ready');
            });
            wx.error(function (res) {
                console.log("error_WX" + res);
                // config信息验证失败会执行error函数，如签名过期导致验证失败，
                // 具体错误信息可以打开config的debug模式查看，
                // 也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
            });
        });

        entity_selectAjax('/getAllMaterialSelect');
        // 9 微信原生接口
        // 9.1.1 扫描二维码并返回结果
        /* document.querySelector('#scanQRCode0').onclick = function () {
             wx.scanQRCode();
         };*/
        // 9.1.2 扫描二维码并返回结果
    })


    layui.use(['form', 'util', 'dropdown', 'layedit', 'laydate'], function () {
        var form = layui.form
            , util = layui.util
            , dropdown = layui.dropdown
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate
            , exe_layer = null
            , load_layer = null
            , status = []
            , e_status = [];

        //自定义验证规则
        form.verify({
            datetime: function (value) {
                if (value.length < 19) {
                    return '也太短了吧！';
                } else {
                    var result = value.match(/^(\d{4})(-|\/)(\d{1,2})\2(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})$/);
                    if (result == null) return '时间格式不对！';
                }
            }
            , lengthCtrl: function (value) {
                if (value.length > 50) {
                    return '容不下！';
                } else if (value.length < 5) {
                    return '也太短了吧！';
                }
            }
        });

        //日期
        laydate.render({
            elem: '#bar_code_date',
            type: 'datetime',
            value: new Date(),
        });

        form.on('select(BC_genre)', function (data) {
            initEntityBsSuggest(0, "devices_class");
            initEntityBsSuggest(0, "devices_entity");
            $("#entity_id").val('');
            if (data.value === '1') entity_selectAjax('/getDeviceSelect');
            else entity_selectAjax('/getAllMaterialSelect');

        });

        form.on('select(BC_type)', function (data) {
            verify_bar_code(form.val('bar_code_register').bar_code + form.val('bar_code_register').bar_code_type + form.val('bar_code_register').bar_code_genre);

        });

        form.on('submit(BC_submit)', function (data) {
            BC_submit(data);
        });

        util.on('lay-on', {
            "get_bar_code": function (othis) {
                $('#bar_code').attr('readonly', false);
                form.val("bar_code_register", { //formTest 即 class="layui-form" 所在元素属性 lay-filter="" 对应的值
                    "entity_id": "" // "name": "value"
                    , "devices_class": ""
                    , "devices_entity": ""
                    , "bar_code_type": ""
                    , "bar_code": ""
                });
                wx.scanQRCode({
                    needResult: 1,
                    scanType: ["qrCode", "barCode"],
                    success: function (res) {
                        var resultStr = res.resultStr.split(',');
                        var str = resultStr[0];
                        if (CheckIsNullOrEmpty(resultStr[1])) {
                            str = resultStr[1];
                        }
                        layer.msg(resultStr[0]);
                        form.val("bar_code_register", {
                            "bar_code": str
                        });
                        if (CheckIsNullOrEmpty(form.val('bar_code_register').bar_code)) {
                            $('#bar_code').attr('readonly', true);
                        }
                    }
                });
            }
        });

    });

</script>

</body>
</html> 