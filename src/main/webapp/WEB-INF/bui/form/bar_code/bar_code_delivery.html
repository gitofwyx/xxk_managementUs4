<!DOCTYPE HTML>
<html>
<head>
    <title> 出库登记</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!--user-scalable控制用户是否可以进行触屏扩大或缩小网页-->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="/css/layui/layui.css">
    <link href="/css/suggest-style.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">

    <style type="text/css">
        code {
            padding: 0px 4px;
            color: #d14;
            background-color: #f7f7f9;
            border: 1px solid #e1e1e8;
        }

    </style>
</head>
<body>

<div class="container">

    <div>
        <div class="row">
            <div id="occupy_area" class="hidden col-xs-12 col-sm-12 col-md-1 col-lg-1"></div>
            <div id="reg_area" class="col-xs-12 col-sm-12 col-md-7 col-lg-7 col-md-offset-2 col-lg-offset-2">
                <!--偏移列 .col-*-offset-* -->
                <form class="form-horizontal layui-form" autocomplete="off" id="reg_area_form"
                      lay-filter="bar_code_delivery">

                    <div class="col-sm-6 col-xs-12 col-lg-6"
                         style="margin-bottom:5px;margin-top:5px;padding-left:0px; ">
                        <label class="col-sm-12 col-xs-12 col-lg-12" style="margin-bottom:5px; ">条码号</label>
                        <div class="col-sm-1 col-xs-10 col-lg-1" style="padding-right:2px; width: 80%">
                            <input type="text" id="bar_code" class="form-control" name="bar_code"
                                   placeholder="请输入或扫码">
                        </div>
                        <div class="col-sm-1 col-xs-2 col-lg-1" style="margin-bottom:5px;padding-left:0px ">
                            <button type="button" id="reg_btn" class="btn btn-default " lay-on="get_bar_code">识码
                            </button>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">设备选择</label>
                        <div id="devices_class_div">
                            <input type="text" id="devices_class" class="form-control"
                                   name="entity_name"
                                   placeholder="请选择">
                            <input type="hidden" name="class_id" id="class_id" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="请选择设备">
                            <ul class="dropdown-menu " role="menu">
                            </ul>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">型号选择</label>
                        <div id="devices_entity_div">
                            <input type="text" id="devices_entity" class="form-control NO_Reset"
                                   name="entity_type"
                                   placeholder="请选择">
                            <input type="hidden" name="entity_id" id="entity_id" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="请选择型号">
                            <ul class="dropdown-menu " role="menu">
                            </ul>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">出库时间</label>
                        <div class="">
                            <input type="text" name="out_confirmed_date" id="out_confirmed_date"
                                   lay-verify="required|datetime"
                                   placeholder="yyyy-MM-dd HH:mm:ss"
                                   autocomplete="off" class="form-control">
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">库存科室</label>
                        <div class="">
                            <input type="text" id="stock_office_ident" class="form-control NO_Reset"
                                   name="stock_office_ident"
                                   placeholder="请选择">
                            <input type="hidden" name="stock_office_id" id="stock_office_id" lay-verify="required"
                                   class="NO_Reset"
                                   lay-verType="alert"
                                   lay-reqText="库存科室不能为空">
                            <ul class="dropdown-menu " role="menu">
                            </ul>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">库存选择</label>
                        <div id="stock_record_suggest">
                            <input type="text" id="stock_ident" class="form-control NO_Reset"
                                   name="stock_ident"
                                   placeholder="请选择">
                            <input type="hidden" name="stock_record_id" id="stock_record_id" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="请选择库存">
                            <ul class="dropdown-menu " role="menu">
                            </ul>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">出库科室</label>
                        <div class="">
                            <input type="text" id="out_confirmed_ident" class="form-control NO_Reset"
                                   name="out_confirmed_ident"
                                   placeholder="请选择">
                            <input type="hidden" name="out_confirmed_officeId" id="out_confirmed_officeId"
                                   lay-verify="required"
                                   class="NO_Reset"
                                   lay-verType="alert"
                                   lay-reqText="出库科室不能为空">
                            <ul class="dropdown-menu " role="menu">
                            </ul>
                        </div>
                    </div>

                    <div id="stock_data_input" class="col-sm-12 col-xs-12 col-lg-12" style="margin-top: 10px">
                        <div id="">
                            <input type="hidden" name="stock_type" id="stock_type" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="库存类别为空">
                            <input type="hidden" name="stock_no" id="stock_no" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="库存数量为空">
                            <input type="hidden" name="stock_unit" id="stock_unit" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="库存单位为空">
                            <input type="hidden" name="stock_total_unit" id="stock_total_unit" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="总量单位为空">
                            <input type="hidden" name="stock_proportion" id="stock_proportion" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="库存比列为空">
                            <input type="hidden" name="stock_total" id="stock_total" lay-verify="required|checkTotal"
                                   lay-verType="alert"
                                   lay-reqText="库存总量为空">
                            <input type="hidden" name="stock_idle_total" id="stock_idle_total"
                                   lay-verify="required|checkTotal"
                                   lay-verType="alert"
                                   lay-reqText="可用库存为空">
                            <input type="hidden" name="out_confirmed_no" id="out_confirmed_no" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="出库数量为空">
                            <input type="hidden" name="out_confirmed_total" id="out_confirmed_total"
                                   lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="出库总量为空">
                            <input type="hidden" name="out_confirmed_unit" id="out_confirmed_unit"
                                   lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="出库单位为空">
                            <input type="hidden" name="out_confirmed_total_unit" id="out_confirmed_total_unit"
                                   lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="出库总量单位为空">
                            <input type="hidden" name="stock_version" id="stock_version"
                                   lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="版本号为空">

                            <ul class="dropdown-menu " role="menu">
                            </ul>
                        </div>
                        <div>
                            <button type="button" class="btn btn-primary btn-block" id="bar_code_submit" lay-submit
                                    lay-filter="bar_code_submit">新增
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div id="table_area" class="col-xs-12 col-sm-12 col-md-7 col-lg-7 col-md-offset-2 col-lg-offset-2">

                <table class="layui-hide" id="test" lay-filter="test"></table>

            </div>

        </div>
    </div>


</div>
<script type="text/javascript" src="/js/jquery-1.8.1.min.js"></script>

<script src="/js/layui/layui.js"></script>

<script type="text/javascript" src="/js/tree/tree_build.js"></script>
<script type="text/javascript" src="/js/localstorageIO.js"></script>
<script type="text/javascript" src="/js/tools/data_handling.js"></script>
<script type="text/javascript" src="/js/suggest/bootstrap-suggest.js"></script>

<script type="text/javascript" src="/js/suggest/suggest_util.js"></script>
<script type="text/javascript" src="/js/callback_ajax.js"></script>

<script type="text/javascript" src="http://res2.wx.qq.com/open/js/jweixin-1.6.0.js"></script>

<script type="text/javascript">

    var device_data = [],//全部dev初始化
        entity_data = [],//型号初始化
        offices_select = localstorageIO("offices_select", "/getOfficeSelect");

    function verify_bar_code(ident) {

        var BC_device = [],
            BC_entity = [];
        CD_ajaxAllParam("/lisBar_codeByINSTRBar_code_ident", {
            bar_code_ident: ident,
            "TD": "logout"
        }, true, function (data) {
            if (data == null) {
                originalSeaEntity(device_data.Class_data);
                layer.msg('该条码没有绑定任何信息,请手动选择_',
                    {icon: 5, time: 3000,},
                    function (index) {
                        layer.close(index);
                    });
                return;
            }
            if (!result_handle(data)) {
                layer.msg(data.error, {icon: 2, time: 5000,},
                    function (index) {
                        layer.close(index);
                    });
                return;
            }
            initEntityBsSuggest(0, "devices_class");
            initEntityBsSuggest(0, "devices_entity");
            data.entityData.filter(function (BC_data, index) {
                device_data.Entity_data.filter(function (entity, index) {
                    if (BC_data.entity_id === entity.value) {
                        BC_entity.push(entity);
                        device_data.Class_data.filter(function (cla, index) {
                            if (entity.dev_class_id === cla.value) {
                                BC_device.push(cla);
                            }
                        })
                    }
                });
            });
            if (BC_device.length == 1 && BC_entity.length == 1) {
                $("#class_id").val(BC_device[0].value);
                $("#entity_id").val(BC_entity[0].value);
                $('#devices_entity').val(BC_device[0].text);
                $('#devices_class').val(BC_entity[0].text);
                $('#devices_entity').attr('readonly', true);
                $('#devices_class').attr('readonly', true);
                return;
            }
            originalSeaEntity(BC_device);
        });
    }

    //型号生成
    function changeEntClass(ev, i) {
        entity_data = [];
        var Entity_data = device_data.Entity_data;
        for (var j = 0, len = Entity_data.length; j < len; j++) {
            if (Entity_data[j].dev_class_id == i) {
                entity_data.push(Entity_data[j]);
            }
        }
    }

    function assemble_stock(v) {
        $("#stock_record_id").val(v.value);
        $("#stock_proportion").val(v.stock_proportion);
        $("#stock_type").val(v.stock_type);
        $("#stock_unit").val(v.stock_unit);
        $("#stock_total").val(v.stock_total);
        $("#stock_idle_total").val(v.stock_idle_total);
        $("#stock_total_unit").val(v.stock_total_unit);
        $("#out_confirmed_unit").val(v.stock_total_unit);
        $("#out_confirmed_total_unit").val(v.stock_total_unit);
        $("#stock_version").val(v.stock_version);
    }

    //下拉提示框bsSuggest
    function initEntityBsSuggest(t, cla, v, callback, onUnset_ck) {
        var options = {
            /*url: "/getMaterialName?tab=" + v,*/
            data: v,
            effectiveFields: ["text", "class_ident"],
            searchFields: ["text", "class_ident"],
            effectiveFieldsAlias: {class_ident: "编号", text: "名称"},
            listAlign: 'auto',
            showBtn: false,
            autoMinWidth: false,
            getDataMethod: 'data',
            idField: "value",
            keyField: "text",
            clearable: true,
        };
        if (t == 1) {
            $("#" + cla).bsSuggest('init', options).on('onDataRequestSuccess', function (e, result) {
                console.log('onDataRequestSuccess: ', result);
            }).on('onSetSelectValue', function (e, keyword, data) {
                console.log('onSetSelectValue: ', keyword, data);
                //回调函数
                if (typeof callback === "function") {
                    //调用它，既然我们已经确定了它是可调用的
                    callback(keyword, data);
                }

            }).on('onUnsetSelectValue', function () {
                if (typeof onUnset_ck === "function") {
                    //调用它，既然我们已经确定了它是可调用的
                    onUnset_ck();
                }
            });
        } else if (t == 0) {
            $("#" + cla).bsSuggest('destroy');
        }

    };

    //初始化BsSuggest
    function originalSeaEntity(e) {
        initEntityBsSuggest(0, "devices_class");
        initEntityBsSuggest(0, "devices_entity");
        $('#devices_class_div').replaceWith('<div id="devices_class_div"> <input type="text" id="devices_class" class="form-control" name="entity_name" ' +
            'placeholder="请选择"> <input type="hidden" name="class_id" id="class_id" lay-verify="required" lay-verType="alert" lay-reqText="请选择设备"> ' +
            '<ul class="dropdown-menu " role="menu"> </ul></div>');
        if (!$.isEmptyObject(e)) {
            initEntityBsSuggest(1, "devices_class", {value: e}, function (K, data) {
                $("#class_id").val(data.value);
                initEntityBsSuggest(0, "devices_entity");
                $('#devices_entity_div').replaceWith('<div id="devices_entity_div"> <input type="text" id="devices_entity" class="form-control NO_Reset" ' +
                    'name="entity_type" placeholder="请选择"> <input type="hidden" name="entity_id" id="entity_id" lay-verify="required" lay-verType="alert" ' +
                    'lay-reqText="请选择型号"> <ul class="dropdown-menu " role="menu"> </ul> </div>');
                if (!$.isEmptyObject(data)) {
                    changeEntClass(K, data.value);
                    initEntityBsSuggest(1, "devices_entity", {value: entity_data}, function (K, data) {
                        $("#entity_id").val(data.value);
                    }, function () {
                        $("#entity_id").val('');
                    });
                }
            }, function () {
                $("#class_id").val('');
                $("#entity_id").val('');
            });
        }
    };

    function stock_officeSuggest(i, onSet_ck, onUnset_ck) {

        buildBsSuggestIO(i,
            {
                /*url: "/getMaterialName?tab=" + v,*/
                data: {
                    value: offices_select.filter(function (office, index) {
                        if (CheckIsNullOrEmpty(office.office_function)) {
                            return office.office_function == 1;
                        }
                    })
                },
                effectiveFields: ["text", ""],
                searchFields: ["text", "id", "pinYin_code", "pinYinS_code"],
                effectiveFieldsAlias: {"text": "科室名称",},
                listAlign: 'auto',
                showBtn: false,
                autoMinWidth: false,
                getDataMethod: 'data',
                idField: "value",
                keyField: "text",
                clearable: true,
            },
            function (K, data) {
                $("#stock_office_id").val(data.value);
                var sData = {
                    entity_id: $('#entity_id').val(),
                    office_id: data.value,
                };
                stock_recordUpdate(sData);
            }, onUnset_ck,
        );
    }

    //下拉框ajax请求entity_selectAjax
    function entity_selectAjax(callback) {
        var url = '/getAllMaterialSelect';
        if ($.isEmptyObject(device_data)) {
            $.ajax({
                url: url,
                data: {tab: 1},
                type: 'POST', //GET
                async: true,    //或false,是否异步
                /*timeout: 5000,*/    //超时时间(如果后台数据加载缓慢，设置超时时间会导致在时间超时后自动执行success函数而后台还没有返回data数据)
                dataType: 'json',    //返回的数据格式：json/xml/html/script/jsonp/text
                success: function (data, textStatus, jqXHR) {
                    if (data != null && data != undefined) {
                        device_data = data;
                        originalSeaEntity(device_data.Class_data);
                    }
                    //回调函数
                    if (typeof callback === "function") {
                        //调用它，既然我们已经确定了它是可调用的
                        callback();
                    }
                },
                error: function (xhr, textStatus) {
                    console.log('错误')
                    console.log(xhr)
                    console.log(textStatus)
                }
            })
        }
    }

    //入库总量生成
    function reckon_stock_total(num, stock_proportion) {  //（输入的库存数量 库存比例)
        //I_Form.getField('in_confirmed_no').get('value');
        num = "" + num;//防止输入数值造成replace函数报错；
        var decimal = num.replace(/\d+\.(\d*)/, "$1");//获取小数部分
        var unit = parseInt(num);//去除小数部分
        stock_proportion = parseInt(stock_proportion);//防止比例数输入为小数
        if (parseFloat(num) != unit) {
            unit = unit * stock_proportion;
            return unit + parseInt(decimal);
        }
        return unit * stock_proportion;
    }

    //根据库存总量生成库存数量
    function makeInNum(total, stock_proportion) { //总量，比例数
        var num = total % stock_proportion;
        while (num >= 1) {
            num = num / 10;
        }
        num = parseInt(total / stock_proportion) + num;
        return num;
    }

    //出库数量输入框光标移出事件
    function stock_delivers() {
        $("#out_confirmed_no").val($("#out_confirmed_no2").val());
        var O_num = $("#out_confirmed_no2").val();//获取入库数量no
        var proportion = $("#stock_proportion").val();
        var out_stock_total = reckon_stock_total(O_num, proportion);
        $("#out_confirmed_total").val(out_stock_total);
        $("#out_confirmed_total2").val(out_stock_total);
        O_num = $("#stock_idle_total").val() - out_stock_total;
        $("#stock_idle_total").val(O_num);
        $("#stock_no").val(makeInNum(O_num, proportion));
    };

    function stock_recordUpdate(v) {

        initEntityBsSuggest(0, "stock_ident");
        $('#stock_record_suggest').replaceWith('<div id="stock_record_suggest"> <input type="text" id="stock_ident" class="form-control NO_Reset" ' +
            'name="stock_ident" placeholder="请选择"> <input type="hidden" name="stock_record_id" id="stock_record_id" lay-verify="required" ' +
            'lay-verType="alert" lay-reqText="请选择库存"> <ul class="dropdown-menu " role="menu"> </ul></div>');

        buildBsSuggestIO("stock_ident",
            {
                url: '/getStockSuggest?entity_id=' + v.entity_id + '&office_id=' + v.office_id,
                /*data: data,*/
                effectiveFields: ["text", "stock_total_unit", "stock_idle_total"],
                searchFields: ["text"],
                effectiveFieldsAlias: {text: "编号", stock_total_unit: "单位", stock_idle_total: "剩余总量"},
                listAlign: 'auto',
                showBtn: false,
                autoMinWidth: false,
                getDataMethod: 'url',
                idField: "value",
                keyField: "text",
                clearable: true,
            }, function (K, data) {
                if (!$.isEmptyObject(data)) {
                    assemble_stock(data);
                    var delivers_in = layer.open({
                        type: 1
                        , resize: false
                        , shadeClose: true
                        , area: 'auto'
                        , title: 'layer + form'
                        , content: ['<ul class="layui-form layui-form-pane" style="margin: 15px;">'
                            , '<li class="layui-form-item">'
                            , '<label class="layui-form-label">数量</label>'
                            , '<div class="layui-input-block">'
                            , '<input class="layui-input" lay-verify="required" id="out_confirmed_no2" name="out_confirmed_no2">'
                            , '</div>'
                            , '</li>'
                            , '<li class="layui-form-item">'
                            , '<label class="layui-form-label">库存比例</label>'
                            , '<div class="layui-input-inline" style="width:100px;">'
                            , '<input class="layui-input" lay-verify="required" id="stock_proportion2" name="stock_proportion2" readonly="readonly">'
                            , '</div>'
                            , '</li>'
                            , '<li class="layui-form-item">'
                            , '<label class="layui-form-label">总量</label>'
                            , '<div class="layui-input-block">'
                            , '<input class="layui-input" lay-verify="required" id="out_confirmed_total2" name="out_confirmed_total2" readonly="readonly">'
                            , '</div>'
                            , '</li>'
                            , '<li class="layui-form-item" style="text-align:center;">'
                            , '<button type="submit" id="total_btn" class="layui-btn">提交</button>'
                            , '</li>'
                            , '</ul>'].join('')
                        , success: function (layero, index) {
                            $("#stock_proportion2").val(data.stock_proportion + ' ：1');
                            if (CheckIsNullOrEmpty($("#out_confirmed_no").val()) && CheckIsNullOrEmpty($("#out_confirmed_total").val())) {
                                $("#out_confirmed_no2").val($("#out_confirmed_no").val());
                                $("#out_confirmed_total2").val($("#out_confirmed_total").val());
                                $("#stock_idle_total").val($("#stock_idle_total").val() - $("#out_confirmed_total").val());
                            }
                            $('#out_confirmed_no2').blur(function () {
                                $("#stock_idle_total").val(data.stock_idle_total);
                                if (!CheckIsNullOrEmpty($("#out_confirmed_no2").val())) {
                                    return;
                                }
                                var out_stock_total = reckon_stock_total($("#out_confirmed_no2").val(), $("#stock_proportion").val()),
                                    O_num = data.stock_idle_total - out_stock_total;
                                if (O_num < 0) {
                                    layer.msg('出库总量：' + out_stock_total + ',不能大于剩余总量：' + data.stock_idle_total,
                                        function (index) {
                                            layer.close(index);
                                        });
                                } else stock_delivers();
                            })
                            $('#total_btn').click(function () {
                                layer.msg('出库总量：' + $("#out_confirmed_total2").val() + ';剩余总量：' + $("#stock_idle_total").val() + ';',
                                    {
                                        icon: 1,
                                        time: 1000,
                                    },
                                    function (index) {
                                        layer.close(index);
                                        layer.close(delivers_in);
                                    });
                            })
                        }
                    });
                }
            }, function () {
                $("#stock_data_input input").each(function () {
                    $(this).val('');
                });
            });

    };

    function out_officeSuggest(i, onSet_ck, onUnset_ck) {

        buildBsSuggestIO(i,
            {
                /*url: "/getMaterialName?tab=" + v,*/
                data: {value: offices_select},
                effectiveFields: ["text", ""],
                searchFields: ["text", "id", "pinYin_code", "pinYinS_code"],
                effectiveFieldsAlias: {"text": "科室名称",},
                listAlign: 'auto',
                showBtn: false,
                autoMinWidth: false,
                getDataMethod: 'data',
                idField: "value",
                keyField: "text",
                clearable: true,
            },
            function (K, data) {
                $("#out_confirmed_officeId").val(data.value);
            }, onUnset_ck,
        );
    }

    function BC_submit(data) {

        data.field.TD = "logout";
        CD_ajaxAllParam("/updateStockForMaterial", data.field, true, function (v) {
                $("#stock_ident").val('');
                $("#bar_code").val('');
                if (result_handle(v)) {
                    $("#stock_data_input input").each(function () {
                        $(this).val('');
                    });
                    layer.msg('出库记录完成', {icon: 1, time: 1000,},
                        function (index) {
                            layer.close(index);
                        });
                } else {
                    layer.msg(v.error, {icon: 2, time: 5000,},
                        function (index) {
                            layer.close(index);
                        });
                }
            }
        );
    }

    $(function () {

        if (offices_select == undefined || offices_select == null) {
            CD_ajaxAllParam("/getOfficeSelect",
                {"updateDate": "NO"},
                true,
                function (v) {
                    if (v != null && v != undefined) {
                        offices_select = v.result;
                        stock_officeSuggest("stock_office_ident");
                        out_officeSuggest("out_confirmed_ident");
                    }
                }
            );
        } else {
            stock_officeSuggest("stock_office_ident");
            out_officeSuggest("out_confirmed_ident");
        }
        ;

        CD_ajaxAllParam("/makeSDKSignature", {
            url: "http://ng4crp.natappfree.cc/test/testBar_code_delivery",
            "TD": "logout"
        }, true, function (data) {
            wx.config({
                debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                appId: data.appId, // 必填，公众号的唯一标识
                timestamp: data.timestamp, // 必填，生成签名的时间戳
                nonceStr: data.nonceStr, // 必填，生成签名的随机串
                signature: data.signature,// 必填，签名
                jsApiList: ['scanQRCode'] // 必填，需要使用的JS接口列表
            });
            wx.ready(function () {
                console.log('wx_ready');
            });
            wx.error(function (res) {
                console.log("error_WX" + res);
                // config信息验证失败会执行error函数，如签名过期导致验证失败，
                // 具体错误信息可以打开config的debug模式查看，
                // 也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
            });
        });

        entity_selectAjax();
        // 9 微信原生接口
        // 9.1.1 扫描二维码并返回结果
        /* document.querySelector('#scanQRCode0').onclick = function () {
             wx.scanQRCode();
         };*/
        // 9.1.2 扫描二维码并返回结果
    })


    layui.use(['form', 'util', 'table', 'dropdown', 'layedit', 'laydate'], function () {
        var form = layui.form
            , util = layui.util
            , table = layui.table
            , dropdown = layui.dropdown
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate
            , exe_layer = null
            , load_layer = null
            , status = []
            , e_status = [];

        //自定义验证规则
        form.verify({
            datetime: function (value) {
                if (value.length < 19) {
                    return '也太短了吧！';
                } else {
                    var result = value.match(/^(\d{4})(-|\/)(\d{1,2})\2(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})$/);
                    if (result == null) return '时间格式不对！';
                }
            }
            , lengthCtrl: function (value) {
                if (value.length > 50) {
                    return '容不下！';
                } else if (value.length < 5) {
                    return '也太短了吧！';
                }
            }
            , checkTotal: function (value) {
                if (value.length < 0) {
                    return '不能小于0！';
                }
            }
        });

        table.render({
            elem: '#test'
            , url: '/listStock' // 此处为静态模拟数据，实际使用时需换成真实接口
            , where: {
                pageIndex: 'curr' //页码的参数名称，默认：page
                , limit: 'nums' //每页数据量的参数名，默认：limit
                , search_class_id: ''
                , search_entity_id: ''
                , search_office_id: ''
                , search_type: ''
            }
            , height: '380' // 最大高度减去其他容器已占有的高度差
            , width: 'auto'
            , totalRow: true // 开启合计行
            , page: true
            , cols: [[
                {field: 'id', fixed: 'left', width: '30%', title: '名称', sort: true, totalRowText: '合计：'}
                , {field: 'id', fixed: 'left', width: '28%', title: '科室',}
                , {field: 'id', fixed: 'left', width: '22%', title: '总量',}
                , {field: 'id', width: '22%', title: '单位',}
                , {field: 'id', width: '10%', title: '数量',}
            ]]
            , done: function () {
                var id = this.id;


            }
            , error: function (res, msg) {
                console.log(res, msg)
            }
        });

        //日期
        laydate.render({
            elem: '#out_confirmed_date',
            type: 'datetime',
            value: new Date(),
        });

        form.on('submit(bar_code_submit)', function (data) {
            BC_submit(data);
        });

        util.on('lay-on', {
            "get_bar_code": function (othis) {

                $('#bar_code').attr('readonly', false);
                if (CheckIsNullOrEmpty(form.val('bar_code_delivery').bar_code)) {
                    verify_bar_code(form.val('bar_code_delivery').bar_code);
                    form.val("bar_code_delivery", {
                        "bar_code": ""
                    });
                    return;
                }
                wx.scanQRCode({
                    needResult: 1,
                    scanType: ["qrCode", "barCode"],
                    success: function (res) {
                        var resultStr = res.resultStr.split(',');
                        var str = resultStr[0];
                        if (CheckIsNullOrEmpty(resultStr[1])) {
                            str = resultStr[1];
                        }
                        form.val("bar_code_delivery", {
                            "bar_code": str
                        });
                        verify_bar_code(form.val('bar_code_delivery').bar_code);
                    }
                });
            }
        });

    });

</script>

</body>
</html>