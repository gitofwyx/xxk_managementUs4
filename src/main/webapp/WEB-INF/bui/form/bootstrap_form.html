<!DOCTYPE HTML>
<html>
<head>
    <title> 资源文件结构</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <!--user-scalable控制用户是否可以进行触屏扩大或缩小网页-->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="/css/layui/layui.css">
    <link href="/css/suggest-style.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">

    <style type="text/css">
        code {
            padding: 0px 4px;
            color: #d14;
            background-color: #f7f7f9;
            border: 1px solid #e1e1e8;
        }

        @media only screen and (max-width: 991px) {
            /*.media-icon-lead:before{content:"\e619"}*/
            .media-icon-lead {
                width: 100%;
                height: 30px;
                background-image: url("/img/top_lead.svg");
                background-repeat: no-repeat;
                padding-bottom: 4px;
            }
        }

        @media screen and (min-width: 992px) {
            /*.media-icon-lead:before{content:"\e603"}*/
            .media-icon-lead {
                width: 100%;
                height: 30px;
                background-image: url("/img/left_lead.svg");
                background-repeat: no-repeat;
                padding-bottom: 3px;
            }
        }
    </style>
</head>
<body>

<div class="container">

    <div>
        <div class="row">
            <div id="occupy_area" class="hidden col-xs-12 col-sm-12 col-md-1 col-lg-1"></div>
            <div id="reg_area" class="col-xs-12 col-sm-12 col-md-7 col-lg-7 col-md-offset-2 col-lg-offset-2">
                <!--偏移列 .col-*-offset-* -->
                <form class="form-horizontal layui-form" autocomplete="off" id="reg_area_form">
                    <h3 class="form-signin-heading" style="margin-top:20px;margin-bottom:5px; ">登记</h3>
                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">登记科室</label>
                        <div class="">
                            <input type="text" id="reg_office_ident" class="form-control" name="reg_office_ident"
                                   placeholder="请选择">
                            <input type="hidden" name="reg_office_id" id="reg_office_id" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="登记科室不能为空">
                            <ul class="dropdown-menu " role="menu">
                            </ul>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">执行科室</label>
                        <div class="">
                            <input type="text" id="exe_office_ident" class="form-control" name="exe_office_ident"
                                   placeholder="请选择">
                            <input type="hidden" name="exe_office_id" id="exe_office_id" lay-verify="required"
                                   lay-verType="alert"
                                   lay-reqText="执行科室不能为空">
                            <ul class="dropdown-menu " role="menu">
                            </ul>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">登记时间</label>
                        <div class="">
                            <!--<input type="date" id="32423" class="form-control" name="email"
                                   placeholder="请输入">-->
                            <input type="text" name="reg_date" id="reg_date" lay-verify="required|datetime"
                                   placeholder="yyyy-MM-dd HH:mm:ss"
                                   autocomplete="off" class="form-control">
                        </div>
                    </div>
                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">登记人</label>
                        <div class="">
                            <input type="text" id="32423" class="form-control" name=""
                                   placeholder="请输入">
                        </div>
                    </div>

                    <div class="col-sm-12 col-xs-12 col-lg-12" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">登记类型</label>
                        <div class="">
                            <input type="checkbox" name="like[write]" title="维护申请">
                            <input type="checkbox" name="like[read]" title="耗材申请">
                            <div class="visible-xs" style="margin-bottom:10px; "></div>
                            <input type="checkbox" name="like[game]" title="设备申请" disabled>
                        </div>
                    </div>

                    <label class="col-sm-12 col-xs-12 col-lg-12" style="margin-bottom:3px; ">登记内容录入</label>
                    <div class="col-sm-11 col-xs-12 col-lg-11" style="margin-bottom:5px; padding-right:0px ">

                        <input type="text" id="reg_record_content" class="form-control" name="reg_record_content"
                               style="width: 97% "
                               placeholder="请选择录入">

                    </div>

                    <div class="col-sm-1 col-xs-12 col-lg-1" style="margin-bottom:5px;padding-left:0px ">
                        <div class=" col-xs-1 visible-xs" style="padding:0px;width: 15px; ">
                        </div>
                        <button type="button" id="reg_describe_btn" class="btn btn-default ">描述</button>
                    </div>

                    <div id="reg_describe_area" class="hidden col-sm-12 col-xs-12 col-lg-12"
                         style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">详细描述</label>
                        <div class="">
                            <textarea class="form-control" name="reg_record_describe" rows="5"></textarea>
                        </div>
                    </div>

                    <div class="col-sm-12 col-xs-12 col-lg-12" style="margin-top: 10px">
                        <div>
                            <button type="button" class="btn btn-primary btn-block" id="reg_record_submit" lay-submit
                                    lay-filter="regForm">登录
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!--登记记录栏-->
            <div id="reg_record" class="hidden col-xs-12 col-sm-12 col-md-4 col-lg-4">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                    <legend><a id="record_select">登记记录</a>
                        (<i id="record_status_icon" class="layui-icon layui-icon-tips" style="color: #f10e3b;">
                        </i>
                        <a id="record_status">
                            未受理</a>)&nbsp;
                        <i class="media-icon-lead">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        </i>
                    </legend>
                </fieldset>
                <div id="registration_record_part">
                    <!--<ul class="layui-timeline">
                        <#if (result.RecordMap)??>
                        <#list result.RecordMap as recordMap>
                          <#list recordMap?keys as recordDate>
                        <li class="layui-timeline-item">
                            <i class="layui-icon layui-timeline-axis"></i>
                            <div class="layui-timeline-content layui-text">
                                <h3 class="layui-timeline-title">${recordDate}</h3>
                                <p>
                                    <#assign item = recordMap[recordDate]>
                                    <#list item as record>
                                    <i class="layui-icon layui-icon-tips" style="color: #f10e3b;"></i>&nbsp;${record.reg_record_content}<br>
                                    &nbsp;<i class="layui-icon layui-icon-username" style="font-size: 12px;color: #635f5f;">${result.userName}&nbsp;登记于${record.reg_record_date}</i>&nbsp;
                                    <i class="layui-icon layui-icon-up" style="font-size: 12px;color: #635f5f;"></i>
                                    <br>
                                    <div style="height: 5px"></div>
                                    </#list>
                                </p>
                            </div>
                        </li>
                           </#list>
                        </#list>
                        </#if>
                    </ul>-->
                </div>
            </div>
        </div>
    </div>


</div>
<script type="text/javascript" src="/js/jquery-1.8.1.min.js"></script>

<script src="/js/layui/layui.js"></script>

<script type="text/javascript" src="/js/tree/tree_build.js"></script>
<script type="text/javascript" src="/js/localstorageIO.js"></script>
<script type="text/javascript" src="/js/tools/data_handling.js"></script>
<script type="text/javascript" src="/js/suggest/bootstrap-suggest.js"></script>

<script type="text/javascript" src="/js/suggest/suggest_util.js"></script>
<script type="text/javascript" src="/js/callback_ajax.js"></script>

<script type="text/javascript">
    var offices_select = null,
        rec_id = null;
    rmV_1 = 0;
    if (offices_select == undefined || offices_select == null) {
        offices_select = localstorageIO("offices_select", "/getOfficeSelect");
        if (offices_select == null) {   //offices_select为null表示浏览器不支持localstorage
            alert("浏览器不支持localstorage！");
            $.ajax({
                url: '/getOfficeSelect',
                type: 'POST', //GET
                async: true,    //或false,是否异步
                /*timeout: 5000,*/    //超时时间(如果后台数据加载缓慢，设置超时时间会导致在时间超时后自动执行success函数而后台还没有返回data数据)
                dataType: 'json',    //返回的数据格式：json/xml/html/script/jsonp/text
                success: function (data, textStatus, jqXHR) {
                    if (data != null && data != undefined) {
                        offices_select = data.result;

                    }
                },
                error: function (xhr, textStatus) {
                    console.log('错误')
                    console.log(xhr)
                    console.log(textStatus)
                }
            })
        }
    }

    function useBsSuggest(i, onSet_ck, onUnset_ck) {

        buildBsSuggestIO(i,
            {
                /*url: "/getMaterialName?tab=" + v,*/
                data: {
                    value: offices_select.filter(function (office, index) {
                        if (CheckIsNullOrEmpty(office.office_property)) {
                            return office.office_property != 0;
                        }
                        return office;
                    })
                },
                effectiveFields: ["text", "class_ident"],
                searchFields: ["text", "class_ident"],
                effectiveFieldsAlias: {"text": "科室名称",},
                listAlign: 'auto',
                showBtn: false,
                autoMinWidth: false,
                getDataMethod: 'data',
                idField: "value",
                keyField: "text",
                clearable: true,
            },
            onSet_ck, onUnset_ck,
        );
    }


    layui.use(['form', 'dropdown', 'layedit', 'laydate'], function () {
        var form = layui.form
            , dropdown = layui.dropdown
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate;

        //自定义验证规则
        form.verify({
            datetime: function (value) {
                if (value.length < 19) {
                    return '也太短了吧！';
                } else {
                    var result = value.match(/^(\d{4})(-|\/)(\d{1,2})\2(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})$/);
                    if (result == null) return '时间格式不对！';
                }
            }
            , pass: [/(.+){6,12}$/, '密码必须6到12位']
            , money: [
                /^\d+\.\b\d{2}\b$/
                , '金额必须为小数保留两位'
            ]
        });

        var reg_record_data = [{
                title: '未受理'
                , id: 100
                , icon: 'layui-icon layui-icon-tips'
                , style: 'color: #f10e3b;'
            }, {
                title: '已受理'
                , id: 101
                , icon: 'layui-icon layui-icon-service'
                , style: 'color: #0E2DF1FF;'
            },],
            exe_record_data = [{
                title: '执行中'
                , id: 102
                , icon: 'layui-icon layui-icon-file'
                , style: 'color: #0E2DF1FF;'
            }, {
                title: '执行完'
                , id: 103
                , icon: 'layui-icon layui-icon-ok'
                , style: 'color: #f10e3b;'
            },],
            reg_record_function = function (obj) {
                $("#record_status").text(obj.title);
                $("#record_status_icon").attr("class", obj.icon);
                $("#record_status_icon").attr("style", obj.style);
                layer.tips('选择了：' + obj.title, this.elem, {tips: [1, '#5FB878']});
            },
            exe_record_function = function (obj) {
                $("#record_status").text(obj.title);
                $("#record_status_icon").attr("class", obj.icon);
                $("#record_status_icon").attr("style", obj.style);
                layer.tips('选择了：' + obj.title, this.elem, {tips: [1, '#5FB878']});
            };

        dropdown.render({
            id: 1001
            , elem: '#record_status'
            , data: reg_record_data
            , click: reg_record_function
        });

        dropdown.render({
            id: 1002
            , elem: '#record_select'
            , data: [{
                title: '登记记录'
                , id: 110
                , icon: 'layui-icon layui-icon-service'
                , style: 'color: #0E2DF1FF;'
                , record_data: reg_record_data
                , record_func: reg_record_function
            }, {
                title: '执行记录'
                , id: 111
                , icon: 'layui-icon layui-icon-tips'
                , style: 'color: #f10e3b;'
                , record_data: exe_record_data
                , record_func: exe_record_function
            },]
            , click: function (obj) {
                $("#record_select").text(obj.title);

                $("#record_status").text(obj.record_data[0].title);
                $("#record_status_icon").attr("class", obj.record_data[0].icon);
                $("#record_status_icon").attr("style", obj.record_data[0].style);

                dropdown.reload(1001, {
                    elem: '#record_status'
                    , data: obj.record_data
                    , click: obj.record_func
                });
            }
        });

        //日期
        laydate.render({
            elem: '#reg_date',
            type: 'datetime',
            value: new Date(),
        });


        function result_handle(data) {
            if (CheckIsNullOrEmpty(data)) {
                if(data.hasError===true){
                    return false;
                }
            }else {
                return false;
            }
            return true;

        }

        function layer_alert(msg,btn,time,btn1_ck,btn2_ck) {
            if (isNaN(time)) {
                time = 5;
            }
            //eg2
            layer.open({
                content: msg
                ,btn: btn
                , time: time*1000
                ,success: function(layero, index){
                    var timeNum = this.time/1000, setText = function(start){
                        layer.title((start ? timeNum : --timeNum) + ' 秒后关闭', index);
                    };
                    setText(!0);
                    this.timer = setInterval(setText, 1000);
                    if(timeNum <= 0) clearInterval(this.timer);
                }
                ,end: function(){
                    clearInterval(this.timer);
                }
                ,yes: function(index, layero){
                    if (typeof btn1_ck === "function") {
                        btn1_ck(index,layero);
                    }
                }
                ,btn2: function(index, layero){
                    if (typeof btn2_ck === "function") {
                        btn2_ck(index,layero);
                    }
                }
                ,btn3: function(index, layero){
                    //按钮【按钮三】的回调

                    //return false 开启该代码可禁止点击该按钮关闭
                }
                ,cancel: function(){
                    //右上角关闭回调

                    //return false 开启该代码可禁止点击该按钮关闭
                }
            });
        }

        function exe_affairs_func() {
            $('.exe-affairs').on('click', function (ev) {

                //alert($(this).children('input').val());
                rec_id = $(this).children('input').val();
                var listRecord = {};
                CD_ajaxAllParam("/getRegistration_recordById", {
                    record_id: rec_id,
                    "TD": "logout"
                }, true, function (data) {
                    if (result_handle(data)) {
                        listRecord = data.listReg_record[0];
                        if (listRecord.reg_record_status === "0") {
                            layer_alert("所选申请未受理，如果当前登录用户是<br>该登记申请人，" +
                                "请在确认该申请已顺利<br>受理后点击已受理，谢谢合作！",['已受理','关闭'], 12
                                ,function (i,l){
                                layer_alert("是否确定该申请已受理？确定后无法撤销！"
                                    ,['确定','不确定'],7,function (i,l) {
                                        CD_ajaxAllParam("/acceptanceRegistration_record",
                                            {
                                                registration_id:listRecord.registration_id,
                                                reg_record_id:listRecord.id,
                                                registration_py:listRecord.reg_record_py,
                                            },
                                            true,function (v) {
                                            if(result_handle(v)) layer.msg('已提交');
                                            else layer.msg(v.error);
                                        });
                                });
                            });
                        }
                    } else {
                        layer_alert(data.error);
                    }
                });


            });
        }

        useBsSuggest("reg_office_ident", function (K, data) {
            $("#reg_office_id").val(data.value);
            if (rmV_1 === 0) {
                $("#reg_area").removeClass("col-md-offset-2 col-lg-offset-2");
                $("#reg_record").removeClass("hidden");
                $("#occupy_area").removeClass("hidden");
                rmV_1 = rmV_1 + 1;
            }
            $("#registration_record_part").load("/test/registration_record_part?TD=logout&office_id=" + data.value, "", exe_affairs_func);
        }, function () {
            $("#reg_office_id").val("");
        });
        useBsSuggest("exe_office_ident", function (K, data) {
            $("#exe_office_id").val(data.value);
        }, function () {
            $("#exe_office_id").val("");
        });

        form.on('submit(regForm)', function (data) {

            CD_ajaxAllParam("/addMobileRegistration", data.field, true, function (v) {
                    $("#registration_record_part").load("/test/registration_record_part?TD=logout&office_id=" + data.field.reg_office_id, "", exe_affairs_func);
                    layer.alert('登记成功。<br>请登记后再次电话联系执行科室，<br>避免执行人员遗漏该登记信息。', {
                        time: 8 * 1000
                        , success: function (layero, index) {
                            var timeNum = this.time / 1000, setText = function (start) {
                                layer.title((start ? timeNum : --timeNum) + ' 秒后关闭', index);
                            };
                            setText(!0);
                            this.timer = setInterval(setText, 1000);
                            if (timeNum <= 0) clearInterval(this.timer);
                        }
                        , end: function () {
                            clearInterval(this.timer);
                        }
                    });
                }
            );
        });

    });

    $('.media-icon-lead').on('click', function () {
        if (rmV_1 === 1) {
            $("#reg_area").addClass("hidden");
            $("#reg_record").attr("class", "col-xs-12 col-sm-12 col-md-10 col-lg-10");
            rmV_1 = rmV_1 + 1;
        } else if (rmV_1 === 2) {
            $("#reg_area").removeClass("hidden");
            $("#reg_record").attr("class", "col-xs-12 col-sm-12 col-md-4 col-lg-4");
            rmV_1 = rmV_1 - 1;
        }
    });

    $('#reg_describe_btn').on('click', function () {

        $("#reg_describe_area").removeClass("hidden");

    });

    /*$('#reg_record_submit').on('click', function(){
        var d = {};
        CD_ajaxAllParam("/addMobileRegistration",$.each($("#reg_area_form").serializeArray(),
            function(i, field){
               return d[field.name] = field.value;
        }),function (){

            }
        );
    });*/

</script>

</body>
</html> 