<!DOCTYPE HTML>
<html>
<head>
    <title> 申请登记</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
    <!--user-scalable控制用户是否可以进行触屏扩大或缩小网页-->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" type="text/css" href="/css/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="/css/layui/layui.css">
    <link href="/css/suggest-style.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">

    <style type="text/css">
        code {
            padding: 0px 4px;
            color: #d14;
            background-color: #f7f7f9;
            border: 1px solid #e1e1e8;
        }

        @media only screen and (max-width: 991px) {
            /*.media-icon-lead:before{content:"\e619"}*/
            .media-icon-lead {
                width: 100%;
                height: 30px;
                background-image: url("/img/top_lead.svg");
                background-repeat: no-repeat;
                padding-bottom: 4px;
            }
        }

        @media screen and (min-width: 992px) {
            /*.media-icon-lead:before{content:"\e603"}*/
            .media-icon-lead {
                width: 100%;
                height: 30px;
                background-image: url("/img/left_lead.svg");
                background-repeat: no-repeat;
                padding-bottom: 3px;
            }
        }
    </style>
</head>
<body>

<div class="container">

    <div>
        <div class="row">
            <div id="occupy_area" class="hidden col-xs-12 col-sm-12 col-md-1 col-lg-1"></div>
            <div id="reg_area" class="col-xs-12 col-sm-12 col-md-7 col-lg-7 col-md-offset-2 col-lg-offset-2">
                <!--偏移列 .col-*-offset-* -->
                <form class="form-horizontal layui-form" autocomplete="off" id="reg_area_form">
                    <h3 class="form-signin-heading" style="margin-top:20px;margin-bottom:5px; ">
                        <i id="reg_form_title" class="layui-icon layui-icon-list" style="font-size: 26px;">登记</i></h3>
                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">登记科室</label>
                        <div class="">
                            <input type="text" id="reg_office_ident" class="form-control NO_Reset"
                                   name="reg_office_ident"
                                   placeholder="请选择">
                            <input type="hidden" name="reg_office_id" id="reg_office_id" lay-verify="required"
                                   class="NO_Reset"
                                   lay-verType="alert"
                                   lay-reqText="登记科室不能为空">
                            <ul class="dropdown-menu " role="menu">
                            </ul>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">执行科室</label>
                        <div class="">
                            <input type="text" id="exe_office_ident" class="form-control NO_Reset"
                                   name="exe_office_ident"
                                   placeholder="请选择">
                            <input type="hidden" name="exe_office_id" id="exe_office_id" lay-verify="required"
                                   class="NO_Reset"
                                   lay-verType="alert"
                                   lay-reqText="执行科室不能为空">
                            <ul class="dropdown-menu " role="menu">
                            </ul>
                        </div>
                    </div>

                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">登记时间</label>
                        <div class="">
                            <!--<input type="date" id="32423" class="form-control" name="email"
                                   placeholder="请输入">-->
                            <input type="text" name="reg_date" id="reg_date" lay-verify="required|datetime"
                                   placeholder="yyyy-MM-dd HH:mm:ss"
                                   autocomplete="off" class="form-control">
                        </div>
                    </div>
                    <div class="col-sm-6 col-xs-12 col-lg-6" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">登记人</label>
                        <div class="">
                            <input type="text" id="32423" class="form-control" name=""
                                   placeholder="请输入">
                        </div>
                    </div>

                    <div class="col-sm-12 col-xs-12 col-lg-12" style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">登记类型</label>
                        <div class="">
                            <input type="checkbox" name="like[write]" title="维护申请">
                            <input type="checkbox" name="like[read]" title="耗材申请">
                            <div class="visible-xs" style="margin-bottom:10px; "></div>
                            <input type="checkbox" name="like[game]" title="设备申请" disabled>
                        </div>
                    </div>

                    <label class="col-sm-12 col-xs-12 col-lg-12" style="margin-bottom:3px; ">登记内容录入</label>
                    <div class="col-sm-11 col-xs-12 col-lg-11" style="margin-bottom:5px; padding-right:0px ">

                        <input type="text" id="reg_record_content" class="form-control" name="reg_record_content"
                               style="width: 97% " lay-verify="lengthCtrl|required"
                               placeholder="请选择录入">

                    </div>

                    <div class="col-sm-1 col-xs-12 col-lg-1" style="margin-bottom:5px;padding-left:0px ">
                        <div class=" col-xs-1 visible-xs" style="padding:0px;width: 15px; ">
                        </div>
                        <button type="button" id="reg_describe_btn" class="btn btn-default ">描述</button>
                    </div>

                    <div id="reg_describe_area" class="hidden col-sm-12 col-xs-12 col-lg-12"
                         style="margin-bottom:10px; ">
                        <label class="control-label" style="margin-bottom:5px; ">详细描述</label>
                        <div class="">
                            <textarea class="form-control" name="reg_record_describe" rows="5"></textarea>
                        </div>
                    </div>

                    <div class="col-sm-12 col-xs-12 col-lg-12" style="margin-top: 10px">
                        <div>
                            <button type="button" class="btn btn-primary btn-block" id="reg_record_submit" lay-submit
                                    lay-filter="regForm">新增
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!--登记记录栏-->
            <div id="reg_record" class="hidden col-xs-12 col-sm-12 col-md-4 col-lg-4">
                <input type="hidden" id="record_select_id" name="record_select_id" value=110>
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                    <legend><a id="record_select">登记记录</a>
                        (<i id="record_status_icon" class="layui-icon layui-icon-triangle-d" style="color: #020202FF;">
                        </i>
                        <a id="record_status">
                            全部</a>)&nbsp;
                        <i class="media-icon-lead">
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        </i>
                    </legend>
                </fieldset>
                <div id="registration_record_part">
                    <!--<ul class="layui-timeline">
                        <#if (result.RecordMap)??>
                        <#list result.RecordMap as recordMap>
                          <#list recordMap?keys as recordDate>
                        <li class="layui-timeline-item">
                            <i class="layui-icon layui-timeline-axis"></i>
                            <div class="layui-timeline-content layui-text">
                                <h3 class="layui-timeline-title">${recordDate}</h3>
                                <p>
                                    <#assign item = recordMap[recordDate]>
                                    <#list item as record>
                                    <i class="layui-icon layui-icon-tips" style="color: #f10e3b;"></i>&nbsp;${record.reg_record_content}<br>
                                    &nbsp;<i class="layui-icon layui-icon-username" style="font-size: 12px;color: #635f5f;">${result.userName}&nbsp;登记于${record.reg_record_date}</i>&nbsp;
                                    <i class="layui-icon layui-icon-up" style="font-size: 12px;color: #635f5f;"></i>
                                    <br>
                                    <div style="height: 5px"></div>
                                    </#list>
                                </p>
                            </div>
                        </li>
                           </#list>
                        </#list>
                        </#if>
                    </ul>-->
                </div>
            </div>
            <div id="ope_record_div" class="col-xs-11 col-sm-11 col-md-6 col-lg-6 col-md-offset-3 col-lg-offset-3"
                 style="display: none; padding: 10px;">
                <input type="hidden" id="" name="record_select_id" value=112>
                <div id="ope_record_part">
                    <!--<ul class="layui-timeline">
                        <#if (result.RecordMap)??>
                        <#list result.RecordMap as recordMap>
                          <#list recordMap?keys as recordDate>
                        <li class="layui-timeline-item">
                            <i class="layui-icon layui-timeline-axis"></i>
                            <div class="layui-timeline-content layui-text">
                                <h3 class="layui-timeline-title">${recordDate}</h3>
                                <p>
                                    <#assign item = recordMap[recordDate]>
                                    <#list item as record>
                                    <i class="layui-icon layui-icon-tips" style="color: #f10e3b;"></i>&nbsp;${record.reg_record_content}<br>
                                    &nbsp;<i class="layui-icon layui-icon-username" style="font-size: 12px;color: #635f5f;">${result.userName}&nbsp;登记于${record.reg_record_date}</i>&nbsp;
                                    <i class="layui-icon layui-icon-up" style="font-size: 12px;color: #635f5f;"></i>
                                    <br>
                                    <div style="height: 5px"></div>
                                    </#list>
                                </p>
                            </div>
                        </li>
                           </#list>
                        </#list>
                        </#if>
                    </ul>-->
                </div>
            </div>
            <div id="ope_area_div" class="col-sm-12 col-xs-12 col-lg-12" style="display: none; padding: 1px;">

                <form class="form-horizontal layui-form" lay-filter="operation_form" autocomplete="off"
                      id="exe_area_form" style="padding-top: 8px">
                    <div class="col-sm-1 col-xs-4 col-lg-1 col-md-offset-10 col-lg-offset-10 col-xs-offset-8">
                        <div>
                            <button type="button" class="btn btn-primary btn-block" id="exe_record_submit"
                                    lay-submit
                                    lay-filter="exeForm">提交
                            </button>
                        </div>
                    </div>
                    <div id="operation_form_div"
                         class="col-xs-12 col-sm-12 col-md-8 col-lg-8" style="padding-right: 1px;padding-left: 1px">
                        <input type="hidden" name="registration_id" id="registration_id" class="NO_Reset">
                        <input type="hidden" name="reg_record_ident" id="reg_record_ident" class="NO_Reset">
                        <input type="hidden" name="reg_record_name" id="reg_record_name" class="NO_Reset">
                        <input type="hidden" name="reg_record_date" id="reg_rec_date" class="NO_Reset">
                        <input type="hidden" name="reg_record_content" id="reg_rec_content" class="NO_Reset">
                        <#if (result.reg_id)??>
                        <input type="hidden" name="reg_record_id" id="reg_record_id" value=${result.reg_id}>
                        </#if>

                        <div class="col-xs-12 col-sm-12 col-md-7 col-lg-7 col-md-offset-4 col-lg-offset-4"
                             style="padding-right: 1px;padding-left: 1px">
                            <div class="col-sm-12 col-xs-12 col-lg-12" style="margin-bottom:10px; ">
                                <label class="control-label" style="margin-bottom:5px; ">处理声明选择</label>
                                <div class="">
                                    <input type="radio" name="ope_statement" value="1" class="NO_Reset" title="调查陈述"
                                           checked>
                                    <input type="radio" name="ope_statement" value="2" class="NO_Reset" title="处理建议">
                                    <div class="visible-xs" style="margin-bottom:10px; "></div>
                                    <input type="radio" name="ope_statement" value="3" class="NO_Reset" title="处理流程">
                                    <input type="radio" name="ope_statement" value="4" class="NO_Reset" title="处理反馈">
                                </div>
                            </div>

                            <label class="col-sm-12 col-xs-12 col-lg-12" style="margin-bottom:5px; ">声明情况录入</label>
                            <div class="col-sm-11 col-xs-12 col-lg-12">

                                <input type="text" id="ope_content" class="form-control" name="ope_content"
                                       lay-verify="lengthCtrl|required"
                                       placeholder="请选择录入">

                            </div>

                            <div id="exe_describe_area" class="col-sm-12 col-xs-12 col-lg-12"
                                 style="margin-bottom:10px; ">
                                <label class="control-label" style="margin-bottom:5px; ">详细描述</label>
                                <div class="">
                                    <textarea class="form-control" name="ope_record_describe" rows="7"></textarea>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div id="ope_form_record_div" class="col-xs-12 col-sm-12 col-md-3 col-lg-3"
                         style=" padding: 10px;">

                        <div id="ope_form_record_part">

                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>


</div>
<script type="text/javascript" src="/js/jquery-1.8.1.min.js"></script>

<script src="/js/layui/layui.js"></script>

<script type="text/javascript" src="/js/tree/tree_build.js"></script>
<script type="text/javascript" src="/js/localstorageIO.js"></script>
<script type="text/javascript" src="/js/tools/data_handling.js"></script>
<script type="text/javascript" src="/js/suggest/bootstrap-suggest.js"></script>

<script type="text/javascript" src="/js/suggest/suggest_util.js"></script>
<script type="text/javascript" src="/js/callback_ajax.js"></script>

<script type="text/javascript">
    var offices_select = null,
        rec_id = null;
    rmV_1 = 0;
    if (offices_select == undefined || offices_select == null) {
        offices_select = localstorageIO("offices_select", "/getOfficeSelect");
        if (offices_select == null) {   //offices_select为null表示浏览器不支持localstorage
            alert("浏览器不支持localstorage！");
            $.ajax({
                url: '/getOfficeSelect',
                data: {"updateDate": "NO"},
                type: 'POST', //GET
                async: false,    //或false,是否异步
                /*timeout: 5000,*/    //超时时间(如果后台数据加载缓慢，设置超时时间会导致在时间超时后自动执行success函数而后台还没有返回data数据)
                dataType: 'json',    //返回的数据格式：json/xml/html/script/jsonp/text
                success: function (data, textStatus, jqXHR) {
                    if (data != null && data != undefined) {
                        offices_select = data.result;

                    }
                },
                error: function (xhr, textStatus) {
                    console.log('错误')
                    console.log(xhr)
                    console.log(textStatus)
                }
            })
        }
    }

    function useBsSuggest(i, onSet_ck, onUnset_ck) {

        buildBsSuggestIO(i,
            {
                /*url: "/getMaterialName?tab=" + v,*/
                data: {
                    value: offices_select.filter(function (office, index) {
                        if (CheckIsNullOrEmpty(office.office_property)) {
                            return office.office_property != 0;
                        }
                        return office;
                    })
                },
                effectiveFields: ["text", ""],
                searchFields: ["text", "id", "pinYin_code", "pinYinS_code"],
                effectiveFieldsAlias: {"text": "科室名称",},
                listAlign: 'auto',
                showBtn: false,
                autoMinWidth: false,
                getDataMethod: 'data',
                idField: "value",
                keyField: "text",
                clearable: true,
            },
            onSet_ck, onUnset_ck,
        );
    }


    layui.use(['form', 'dropdown', 'layedit', 'laydate'], function () {
        var form = layui.form
            , dropdown = layui.dropdown
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate
            , exe_layer = null
            , load_layer = null;

        //自定义验证规则
        form.verify({
            datetime: function (value) {
                if (value.length < 19) {
                    return '也太短了吧！';
                } else {
                    var result = value.match(/^(\d{4})(-|\/)(\d{1,2})\2(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})$/);
                    if (result == null) return '时间格式不对！';
                }
            }
            , lengthCtrl: function (value) {
                if (value.length > 50) {
                    return '容不下！';
                } else if (value.length < 10) {
                    return '也太短了吧！';
                }
            }
            , pass: [/(.+){6,12}$/, '密码必须6到12位']
            , money: [
                /^\d+\.\b\d{2}\b$/
                , '金额必须为小数保留两位'
            ]
        });

        var reg_record_data = [{
                title: '全部'
                , id: 100
                , icon: 'layui-icon layui-icon-triangle-d'
                , style: 'color: 020202FF;'
            }, {
                title: '未受理'
                , id: 101
                , icon: 'layui-icon layui-icon-tips'
                , style: 'color: #f10e3b;'
            }, {
                title: '已受理'
                , id: 102
                , icon: 'layui-icon layui-icon-service'
                , style: 'color: #0E2DF1FF;'
            },],
            exe_record_data = [{
                title: '全部'
                , id: 105
                , icon: 'layui-icon layui-icon-triangle-d'
                , style: 'color: 020202FF;'
            }, {
                title: '未处理'
                , id: 106
                , icon: 'layui-icon layui-icon-reduce-circle'
                , style: 'color: #f10e3b;'
            }, {
                title: '处理中'
                , id: 107
                , icon: 'layui-icon layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop'
                , style: 'color: #0E2DF1FF;'
            },],
            reg_record_function = function (obj) {
                $("#record_status").text(obj.title);
                $("#record_status_icon").attr("class", obj.icon);
                $("#record_status_icon").attr("style", obj.style);
                layer.tips('选择了：' + obj.title, this.elem, {tips: [1, '#5FB878']});
            },
            exe_record_function = function (obj) {
                $("#record_status").text(obj.title);
                $("#record_status_icon").attr("class", obj.icon);
                $("#record_status_icon").attr("style", obj.style);
                layer.tips('选择了：' + obj.title, this.elem, {tips: [1, '#5FB878']});
            };

        dropdown.render({
            id: 1001
            , elem: '#record_status'
            , data: reg_record_data
            , click: reg_record_function
        });

        dropdown.render({
            id: 1002
            , elem: '#record_select'
            , data: [{
                title: '登记记录'
                , id: 110
                , icon: 'layui-icon layui-icon-service'
                , style: 'color: #0E2DF1FF;'
                , record_data: reg_record_data
                , record_func: reg_record_function
            }, {
                title: '执行记录'
                , id: 111
                , icon: 'layui-icon layui-icon-tips'
                , style: 'color: #f10e3b;'
                , record_data: exe_record_data
                , record_func: exe_record_function
            },]
            , click: function (obj) {

                load_layer=layer.open({
                    type: 3,
                    content: '加载中' //这里content是一个普通的String
                });

                $("#record_select").text(obj.title);

                $("#record_status").text(obj.record_data[0].title);
                $("#record_status_icon").attr("class", obj.record_data[0].icon);
                $("#record_status_icon").attr("style", obj.record_data[0].style);

                dropdown.reload(1001, {
                    elem: '#record_status'
                    , data: obj.record_data
                    , click: obj.record_func
                });
                if (obj.id == 110) {
                    var office_id = $("#reg_office_id").val();
                    $("#registration_record_part").load("/reg/registration_record_part",
                        {
                            TD: "logout",
                            office_id: office_id,
                            status: ['0', '1', '2'],
                        },
                        deal_affairs_func);
                }
                if (obj.id == 111) {
                    var office_id = '';
                    $("#registration_record_part").load("/reg/registration_record_part1",
                        {
                            TD: "logout",
                            office_id: office_id,
                            status: ['0', '1', '2'],
                            e_status: ['0', '1'],
                        },
                        exe_affairs_func);
                }
                $("#record_select_id").val(obj.id);
            }
        });

        //日期
        laydate.render({
            elem: '#reg_date',
            type: 'datetime',
            value: new Date(),
        });


        function result_handle(data) {
            if (CheckIsNullOrEmpty(data)) {
                if (data.hasError === true) {
                    return false;
                }
                if (typeof data == 'string') {
                    if (data.indexOf("hasError") >= 0) {
                        return false;
                    }
                }
            } else {
                return false;
            }
            return true;

        }

        function layer_alert(msg, btn, time, btn1_ck, btn2_ck) {
            if (isNaN(time) || !CheckIsNullOrEmpty(time)) {
                time = 5;
            }
            //eg2
            id = layer.open({
                content: msg
                , btn: btn
                , time: time * 1000
                , success: function (layero, index) {
                    var timeNum = this.time / 1000, setText = function (start) {
                        layer.title((start ? timeNum : --timeNum) + ' 秒后关闭', index);
                    };
                    setText(!0);
                    this.timer = setInterval(setText, 1000);
                    if (timeNum <= 0) clearInterval(this.timer);
                }
                , end: function () {
                    clearInterval(this.timer);
                }
                , yes: function (index, layero) {
                    if (typeof btn1_ck === "function") {
                        btn1_ck(index, layero);
                    }
                }
                , btn2: function (index, layero) {
                    if (typeof btn2_ck === "function") {
                        btn2_ck(index, layero);
                    }
                }
                , btn3: function (index, layero) {
                    //按钮【按钮三】的回调

                    //return false 开启该代码可禁止点击该按钮关闭
                }
                , cancel: function () {
                    //右上角关闭回调

                    //return false 开启该代码可禁止点击该按钮关闭
                }
            });
            return id;
        }

        function deal_affairs_func(v) {
            layer.close(load_layer);
            if (result_handle(v)) {
                $('.deal-affairs').on('click', function (ev) {

                    var onLoadT=layer.open({
                        type: 3,
                        content: '加载中' //这里content是一个普通的String
                    });
                    //alert($(this).children('input').val());
                    rec_id = $(this).children('input').val();
                    var listRecord = {};
                    CD_ajaxAllParam("/getRegistration_recordById", {
                        record_id: rec_id,
                        "TD": "logout"
                    }, true, function (data) {
                        if (result_handle(data)) {
                            listRecord = data.listReg_record[0];
                            listRecord.TD = "logout";

                            exe_layer = layer.open({
                                title: '处理流程查看',
                                type: 1,
                                skin: 'layui-layer-rim',
                                area: 'auto',
                                content: $('#ope_record_div'),
                                btn: ['确认', '关闭'],
                                btnAlign: 'c',
                                btn_margin: '20px',
                                maxmin: true,
                                minStack: false, //最小化不堆叠在左下角
                                id: 'operation_form_layer', //定义 ID，防止重复弹出
                                min: function (layero, index) {

                                    layer.msg('阻止了默认的最小化');
                                    layer.style(index, {top: 'auto', bottom: 0});

                                    return false;
                                },
                                success: function (layero, index) {
                                    layer.close(onLoadT);
                                    layer.full(index);
                                    var exe_msg=layer.msg('加载中', {
                                        time: 0, //20s后自动关闭
                                    });
                                    $("#ope_record_part").load("/ope/operation_record_part", listRecord,function () {
                                        layer.close(exe_msg);
                                    });
                                },
                                yes: function (index, layero) {
                                    if (listRecord.reg_record_status === "0" || listRecord.reg_record_status === "1") {
                                        layer_alert("所选申请未受理，如果当前登录用户是<br>该登记申请人，" +
                                            "请在确认该申请已顺利<br>受理后点击已受理，谢谢合作！", ['已受理', '关闭'], 12
                                            , function (i, l) {
                                                layer_alert("是否确定该申请已受理？确定后无法撤销！"
                                                    , ['确定', '不确定'], 7, function (i, l) {
                                                        layer.close(index);
                                                        CD_ajaxAllParam("/acceptanceRegistration_record",
                                                            {
                                                                registration_id: listRecord.registration_id,
                                                                reg_record_id: listRecord.id,
                                                                registration_py: listRecord.reg_record_py,
                                                                TD: 'logout'
                                                            },
                                                            true, function (v) {
                                                                if (result_handle(v)) layer.msg('已提交');
                                                                else layer.msg(v.error);
                                                            });
                                                    });
                                            });
                                    } else layer.close(index);
                                }
                            });

                        } else {
                            layer_alert(data.error, ['确定', '关闭'], '', function () {
                                location.reload();
                            });
                        }
                    });


                });
            } else {
                layer_alert($.parseJSON(v).error, ['确定', '关闭'], '', function () {
                    location.reload();
                });
            }

        }

        function refurbish_record_list(oId) {
            if ($("#record_select_id").val() == 110) {
                $("#registration_record_part").load("/reg/registration_record_part",
                    {
                        TD: "logout",
                        office_id: oId,
                        status: ['0', '1', '2'],
                    },
                    deal_affairs_func);
            }
            if ($("#record_select_id").val() == 111) {
                $("#registration_record_part").load("/reg/registration_record_part1",
                    {
                        TD: "logout",
                        office_id: oId,
                        status: ['0', '1', '2'],
                        e_status: ['0', '1'],
                    },
                    exe_affairs_func);
            }
        }

        function exe_layer_func(v){
            {
                if(CheckIsNullOrEmpty(v.reg_id)) var rec_id =v.reg_id;
                else {
                    layer.msg('无法获取登记ID');
                    return;
                }
                layer.close(load_layer);
                $('#registration_id').val(rec_id);
                exe_layer = layer.open({
                    title: '添加处理流程',
                    type: 1,
                    skin: 'layui-layer-rim',
                    area: 'auto',
                    content: $('#ope_area_div'),
                    btn: ['提交', '关闭'],
                    btnAlign: 'c',
                    btn_margin: '20px',
                    maxmin: true,
                    minStack: false, //最小化不堆叠在左下角
                    id: 'operation_form_layer', //定义 ID，防止重复弹出
                    min: function (layero, index) {

                        layer.msg('阻止了默认的最小化');
                        layer.style(index, {top: 'auto', bottom: 0});

                        return false;
                    },
                    success: function (layero, index) {
                        layer.full(index);
                        var exe_msg=layer.msg('加载中', {
                            time: 0, //20s后自动关闭
                        });
                        CD_ajaxAllParam("/getRegistration_recordById", {
                            record_id: rec_id,
                            "TD": "logout"
                        }, true, function (data) {
                            if (result_handle(data)) {
                                listRecord = data.listReg_record[0];
                                listRecord.TD = "logout";
                                $('#reg_record_ident').val(listRecord.reg_record_ident);
                                $('#reg_record_name').val(listRecord.reg_record_name);
                                $('#reg_rec_date').val(listRecord.reg_record_date);
                                $('#reg_rec_content').val(listRecord.reg_record_content);
                                $("#ope_form_record_part").load("/ope/operation_record_part", listRecord,function () {
                                    layer.close(exe_msg);
                                });
                            } else {
                                layer_alert(data.error, ['确定', '关闭'], '', function () {
                                    location.reload();
                                });
                            }
                        });
                    },
                    yes: function (index, layero) {
                        $('#exe_record_submit').trigger("click");
                        //var data1 = form.val("operation_form");
                        //form.on('submit(exeForm)');
                    }
                });

            }
        }

        function exe_affairs_func(v) {
            layer.close(load_layer);
            //$("#operation_form_div").load("/test/operation_form_part");
            if (result_handle(v)) {
                $('.exe-affairs').on('click', function (ev) {
                    exe_layer_func({"reg_id":$(this).children('input').val()});
                });
            } else {
                layer_alert($.parseJSON(v).error, ['确定', '关闭'], '', function () {
                    location.reload();
                });
            }
        }

        function ope_submit(data) {

            data.field.TD="logout";
            CD_ajaxAllParam("/addMobileOperation", data.field, true, function (v) {
                layer.close(load_layer);
                if (result_handle(v)){

                        CD_ajaxAllParam("/getRegistration_recordById", {
                            record_id: data.field.registration_id,
                            "TD": "logout"
                        }, true, function (data) {
                            if (result_handle(data)) {
                                listRecord = data.listReg_record[0];
                                listRecord.TD = "logout";
                                $("#ope_form_record_part").load("/ope/operation_record_part", listRecord);
                            }
                        });
                        pId = layer_alert("提交完成，继续停留当前窗口？", ['继续', '关闭'], 7, function () {
                            layer.close(pId);
                        }, function () {
                            layer.close(exe_layer);
                            return true;
                        });
                    }else {
                        layer_alert(v.error, ['确定', '关闭'], '', function () {
                           location.reload();
                        });
                    }
                    //$("#registration_record_part").load("/test/registration_record_part?TD=logout&office_id=" + data.field.reg_office_id, "", deal_affairs_func);
                }
            );
        }

        useBsSuggest("reg_office_ident", function (K, data) {
            $("#reg_office_id").val(data.value);
            if (rmV_1 === 0) {
                $("#reg_area").removeClass("col-md-offset-2 col-lg-offset-2");
                $("#reg_record").removeClass("hidden");
                $("#occupy_area").removeClass("hidden");
                rmV_1 = rmV_1 + 1;
            }
            refurbish_record_list(data.value);

        }, function () {
            $("#reg_office_id").val("");
        });
        useBsSuggest("exe_office_ident", function (K, data) {
            $("#exe_office_id").val(data.value);
        }, function () {
            $("#exe_office_id").val("");
        });

        form.on('submit(regForm)', function (data) {
            data.field.TD = "logout";
            var onLoadT=layer.open({
                type: 3,
                content: '提交中' //这里content是一个普通的String
            });
            CD_ajaxAllParam("/addMobileRegistration", data.field, true, function (v) {
                layer.close(onLoadT);
                if (result_handle(v)) {
                    $("#registration_record_part").load("/reg/registration_record_part",
                        {
                            TD: "logout",
                            office_id: data.field.reg_office_id,
                            status: ['0', '1', '2'],
                        },
                        deal_affairs_func);
                    layer.alert('登记成功。<br>请登记后再次电话联系执行科室，<br>避免执行人员遗漏该登记信息。', {
                        time: 8 * 1000
                        , success: function (layero, index) {
                            var timeNum = this.time / 1000, setText = function (start) {
                                layer.title((start ? timeNum : --timeNum) + ' 秒后关闭', index);
                            };
                            setText(!0);
                            this.timer = setInterval(setText, 1000);
                            if (timeNum <= 0) clearInterval(this.timer);
                        }
                        , end: function () {
                            clearInterval(this.timer);
                        }
                    });
                } else {
                    layer_alert(v.error, ['确定', '关闭'], '', function () {
                        location.reload();
                    });
                }
            });
            $("#reg_area_form input").each(function () {
                if (!$(this).hasClass("NO_Reset"))
                    $(this).val('');
            });
            $("#reg_area_form textarea").each(function () {
                if (!$(this).hasClass("NO_Reset"))
                    $(this).val('');
            });
            return false;
        });

        $('#reg_form_title').on('click', function () {
            rmV_1 = 1;
            $(".media-icon-lead").trigger("click");
            refurbish_record_list('');

        });

        $('.media-icon-lead').on('click', function () {
            if (rmV_1 === 1) {
                $("#reg_area").addClass("hidden");
                $("#reg_record").attr("class", "col-xs-12 col-sm-12 col-md-10 col-lg-10");
                rmV_1 = rmV_1 + 1;
            } else if (rmV_1 === 2) {
                $("#reg_area").removeClass("hidden");
                $("#occupy_area").removeClass("hidden");
                $("#reg_area").removeClass("col-md-offset-2 col-lg-offset-2");
                $("#reg_record").attr("class", "col-xs-12 col-sm-12 col-md-4 col-lg-4");
                rmV_1 = rmV_1 - 1;
            }
        });

        form.on('submit(exeForm)', function (data) {

            load_layer=layer.open({
                type: 3,
                content: '加载中' //这里content是一个普通的String
            });
            ope_submit(data);
            $("#exe_area_form input").each(function () {
                if (!$(this).hasClass("NO_Reset"))
                    $(this).val('');
            });
            $("#exe_area_form textarea").each(function () {
                if (!$(this).hasClass("NO_Reset"))
                    $(this).val('');
            });
            return false;
        });

        $(document).ready(function(){

            if(CheckIsNullOrEmpty($('#reg_record_id').val())){
                load_layer=layer.open({
                    type: 3,
                    content: '加载中' //这里content是一个普通的String
                });
                exe_layer_func({"reg_id":$('#reg_record_id').val()});
            }
        });

    });


    $('#reg_describe_btn').on('click', function () {

        $("#reg_describe_area").removeClass("hidden");

    });

    /*$('#reg_record_submit').on('click', function(){
        var d = {};
        CD_ajaxAllParam("/addMobileRegistration",$.each($("#reg_area_form").serializeArray(),
            function(i, field){
               return d[field.name] = field.value;
        }),function (){

            }
        );
    });*/

</script>

</body>
</html> 